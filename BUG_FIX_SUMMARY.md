# Fix for Vertices Going Wild with Scutoids

## Problem Summary

In 3D vertex models simulating biological tissues with scutoids (apico-basal intercalations), vertices were becoming shared by 4 cells instead of the typical 3, causing:

- Extreme force gradients at 4-cell vertices (especially from volume constraints)
- Spiky, unrealistic cell shapes (pointy geometries)
- Numerical explosions causing simulation crashes
- Giant force magnitudes breaking the model

## Root Cause

The bug was located in `src/pyVertexModel/geometry/geo.py` in the `recalculate_ys_from_previous()` function (lines 1058 and 1072).

### The Bug
```python
# OLD BUGGY CODE (line 1058)
tetsToUse = np.sum(np.isin(allTs, num_tet), axis=1) > 2

# Fallback (line 1072)
tetsToUse = np.sum(np.isin(allTs, num_tet), axis=1) > 1
```

**Why this was wrong:**
- `> 2` matches tetrahedra sharing 3 OR 4 nodes
- This allows averaging Y positions across tets that only share a triangular face (3 nodes)
- When multiple cells share the same face configuration, this creates 4-fold (or higher) vertices
- The permissive matching allowed vertices to be incorrectly shared by 4+ cells

### The Fix
```python
# NEW FIXED CODE (line 1060)
tetsToUse = np.sum(np.isin(allTs, num_tet), axis=1) == 4  # Exact match only

# Fallback with validation (line 1075)
tetsToUse = np.sum(np.isin(allTs, num_tet), axis=1) == 3  # Face match
# Plus additional check (line 1085):
if any(tetsToUse) and np.sum(tetsToUse) <= 3:  # Limit to proper 3-fold vertices
```

**Why this is correct:**
- `== 4` matches only the exact same tetrahedron (all 4 nodes match)
- Fallback to `== 3` with validation ensures we don't create 4-fold vertices
- The `<= 3` check ensures we only average across at most 3 matching tets (proper 3-fold configuration)

## Additional Improvements

### 1. Vertex Valence Validation Function
Added `check_vertex_valence()` in `geo.py` to detect and warn about problematic vertices:

```python
def check_vertex_valence(geo, log_warnings=True):
    """
    Check for vertices shared by more than 3 cells (4-fold or higher vertices).
    These can cause numerical instability and simulation crashes.
    """
```

This function:
- Counts how many unique cells each vertex belongs to
- Warns when vertices are shared by more than 3 cells
- Returns a dictionary of problematic vertices with details

### 2. Post-Flip Validation
Modified `post_flip()` in `mesh_remodelling/flip.py` to automatically check for 4-fold vertices after flip operations:

```python
def post_flip(Tnew, Ynew, oldTets, Geo, Geo_n, Geo_0, Dofs, Set, old_geo):
    # ... existing code ...
    
    # Check for 4-fold or higher vertices after flip operation
    check_vertex_valence(Geo, log_warnings=True)
    
    return Geo_0, Geo_n, Geo, Dofs, has_converged
```

## Testing

Created comprehensive unit tests in `Tests/test_vertex_valence.py`:

1. **test_check_vertex_valence_no_issues**: Validates proper 3-fold vertex configurations
2. **test_check_vertex_valence_4_fold_detected**: Confirms 4-fold vertices are detected
3. **test_check_vertex_valence_with_dead_cells**: Ensures dead cells are ignored

All tests pass successfully.

## Expected Impact

This fix should:
1. **Prevent 4-fold vertices** from being created during scutoid/remodeling operations
2. **Improve numerical stability** by avoiding singular or near-singular Jacobian matrices
3. **Reduce simulation crashes** caused by extreme force gradients
4. **Produce more realistic geometries** without spiky, degenerate cell shapes
5. **Provide early detection** of any remaining issues through the validation function

## Files Modified

1. `src/pyVertexModel/geometry/geo.py`:
   - Fixed `recalculate_ys_from_previous()` (lines 1058-1090)
   - Added `check_vertex_valence()` function
   
2. `src/pyVertexModel/mesh_remodelling/flip.py`:
   - Added validation call in `post_flip()`
   
3. `Tests/test_vertex_valence.py`:
   - New test file with comprehensive validation tests

## Recommendations

1. **Monitor simulations** for the warnings generated by `check_vertex_valence()`
2. **If warnings appear**, investigate the geometry and flip operations that led to them
3. **Consider adding** similar validation checks in other remodeling operations
4. **Review force calculations** in the Kg/ files to ensure they handle edge cases gracefully
