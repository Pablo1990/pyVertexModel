import numpy as np
from scipy.spatial import Delaunay

from Tests.tests import Tests, assert_array1D, assert_matrix
from src.pyVertexModel.vertexModel import VertexModel


class TestVertexModel(Tests):

    def test_initialize_geometry_bubbles(self):
        # Load data
        vModel = VertexModel()
        X, X_IDs = build_topo(vModel.geo.nx, vModel.geo.ny, vModel.geo.nz, 0)
        vModel.geo.nCells = X.shape[0]

        # Centre Nodal position at (0,0)
        X[:, 0] = X[:, 0] - np.mean(X[:, 0])
        X[:, 1] = X[:, 1] - np.mean(X[:, 1])
        X[:, 2] = X[:, 2] - np.mean(X[:, 2])

        # First test: compare with initial seeds of cells
        X_initial_expected = np.array([
            [-1, -1, 0],
            [-1, 0, 0],
            [-1, 1, 0],
            [0, -1, 0],
            [0, 0, 0],
            [0, 1, 0],
            [1, -1, 0],
            [1, 0, 0],
            [1, 1, 0]])

        assert_matrix(X_initial_expected, X)

        # Second test: compare with first step
        X_test, XgID_test, XgIDBB, nCells = generate_first_ghost_nodes(X)

        X_expected = np.array([
                [-1.0, -1.0, 0.0],
                [-1.0, 0.0, 0.0],
                [-1.0, 1.0, 0.0],
                [0.0, -1.0, 0.0],
                [0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0],
                [1.0, -1.0, 0.0],
                [1.0, 0.0, 0.0],
                [1.0, 1.0, 0.0],
                [-5.0, 6.12323399573677e-16, 3.06161699786838e-16],
                [-3.53553390593274, 4.32978028117747e-16, -3.53553390593274],
                [-3.53553390593274, 4.32978028117747e-16, 3.53553390593274],
                [-9.18485099360515e-16, -5.0, 3.06161699786838e-16],
                [-6.49467042176620e-16, -3.53553390593274, -3.53553390593274],
                [-6.49467042176620e-16, -3.53553390593274, 3.53553390593274],
                [-6.12323399573677e-16, 7.49879891330929e-32, -5.0],
                [0.0, 0.0, 5.0],
                [2.16489014058873e-16, 3.53553390593274, 3.53553390593274],
                [2.16489014058873e-16, 3.53553390593274, -3.53553390593274],
                [3.06161699786838e-16, 5.0, 3.06161699786838e-16],
                [3.53553390593274, -8.65956056235493e-16, 3.53553390593274],
                [3.53553390593274, -8.65956056235493e-16, -3.53553390593274],
                [5.0, -1.22464679914735e-15, 3.06161699786838e-16]])

        assert_matrix(X_expected, X_test)

        # Perform Delaunay
        XgID_test, X_test = vModel.SeedWithBoundingBox(X, vModel.set.s)

        X_expected = np.array([
            [-1, -1, 0],
            [-1, 0, 0],
            [-1, 1, 0],
            [0, -1, 0],
            [0, 0, 0],
            [0, 1, 0],
            [1, -1, 0],
            [1, 0, 0],
            [1, 1, 0],
            [0.171820963796518, 1.26383691565959, -1.46658366223522],
            [0.509631663390022, 1.25099240242015, -1.39518518784344],
            [0.5, 0.5, -1.25],
            [-1.43693479239827, -2.20933367900116, 0.772398886602891],
            [1.06641702448093, 1.06641702448093, 1.49705629744449],
            [-0.25, -0.25, -1.25],
            [-1.92299398158712, 1.08929483235248, 1.17902864378653],
            [0.5, -0.25, -1.25],
            [0.513335736607712, -0.270003604911569, -1.21666065848072],
            [-0.270003604911569, 0.513335736607712, -1.21666065848072],
            [-0.25, 0.5, -1.25],
            [-1.43693479239827, -2.20933367900116, -0.772398886602890],
            [-1.92299398158712, -1.08929483235248, 1.17902864378653],
            [1.25099240242015, -0.509631663390022, 1.39518518784344],
            [1.26383691565959, -0.171820963796518, 1.46658366223522],
            [-0.438434594743311, 2.22337658215132, 0.661811176894628],
            [-0.200065448226511, 2.30753452029000, 0.707338175610462],
            [-0.513335736607713, 0.270003604911569, -1.21666065848072],
            [-0.5, 0.25, -1.25],
            [-2.30753452029000, -0.200065448226511, 0.707338175610462],
            [-2.22337658215132, -0.438434594743311, 0.661811176894628],
            [-2.30753452029000, 0.200065448226512, 0.707338175610462],
            [-2.22337658215132, 0.438434594743311, 0.661811176894628],
            [0.200065448226511, -2.30753452029000, -0.707338175610461],
            [0.438434594743311, -2.22337658215132, -0.661811176894628],
            [0.171820963796518, -1.26383691565959, 1.46658366223522],
            [0.509631663390022, -1.25099240242015, 1.39518518784344],
            [2.22337658215132, -0.438434594743311, 0.661811176894628],
            [2.30753452029000, -0.200065448226512, 0.707338175610462],
            [-1.92299398158712, -1.08929483235248, -1.17902864378653],
            [1.25099240242015, 0.509631663390022, 1.39518518784344],
            [1.26383691565959, 0.171820963796518, 1.46658366223522],
            [-1.43693479239827, 2.20933367900117, -0.772398886602890],
            [-2.30753452029000, 0.200065448226512, -0.707338175610461],
            [-2.22337658215132, 0.438434594743311, -0.661811176894628],
            [-2.30753452029000, -0.200065448226511, -0.707338175610461],
            [-2.22337658215132, -0.438434594743311, -0.661811176894628],
            [1.08929483235248, -1.92299398158712, -1.17902864378653],
            [0.25, -0.5, 1.25],
            [0.270003604911569, -0.513335736607712, 1.21666065848072],
            [-1.06641702448093, -1.06641702448093, -1.49705629744449],
            [-1.26383691565959, -0.171820963796518, -1.46658366223522],
            [-1.25099240242015, -0.509631663390022, -1.39518518784344],
            [-1.26383691565959, 0.171820963796518, -1.46658366223522],
            [-1.25099240242015, 0.509631663390022, -1.39518518784344],
            [0.25, 0.25, -1.25],
            [2.20933367900116, -1.43693479239828, -0.772398886602890],
            [-0.509631663390022, 1.25099240242015, -1.39518518784344],
            [-0.171820963796518, 1.26383691565959, -1.46658366223522],
            [-1.06641702448093, -1.06641702448093, 1.49705629744449],
            [2.22337658215132, 0.43843459474331, 0.661811176894628],
            [2.30753452029000, 0.200065448226511, 0.707338175610462],
            [2.20933367900117, 1.43693479239827, -0.77239888660289],
            [2.20933367900116, -1.43693479239827, 0.772398886602891],
            [-1.92299398158712, 1.08929483235249, -1.17902864378653],
            [-1.06641702448093, 1.06641702448093, -1.49705629744449],
            [0.25, -0.5, -1.25],
            [0.270003604911568, -0.513335736607713, -1.21666065848072],
            [0.5, -0.25, 1.25],
            [0.513335736607712, -0.270003604911569, 1.21666065848072],
            [-1.43693479239827, 2.20933367900116, 0.772398886602891],
            [-0.438434594743311, -2.22337658215132, 0.661811176894628],
            [-0.200065448226512, -2.30753452029000, 0.707338175610462],
            [1.08929483235248, 1.92299398158712, 1.17902864378653],
            [-0.438434594743311, 2.22337658215132, -0.661811176894628],
            [-0.200065448226511, 2.30753452029000, -0.707338175610461],
            [2.20933367900116, 1.43693479239827, 0.772398886602891],
            [0.200065448226511, 2.30753452029000, 0.707338175610462],
            [0.438434594743311, 2.22337658215132, 0.661811176894628],
            [0.200065448226511, 2.30753452029000, -0.707338175610461],
            [0.438434594743311, 2.22337658215132, -0.661811176894628],
            [1.08929483235248, -1.92299398158712, 1.17902864378653],
            [0.200065448226511, -2.30753452029000, 0.707338175610462],
            [0.438434594743311, -2.22337658215132, 0.661811176894628],
            [0.25, 0.25, 1.25],
            [0.5, 0.5, 1.25],
            [0.171820963796518, 1.26383691565959, 1.46658366223522],
            [0.509631663390022, 1.25099240242015, 1.39518518784344],
            [-0.509631663390022, 1.25099240242015, 1.39518518784344],
            [-0.171820963796518, 1.26383691565959, 1.46658366223522],
            [-1.06641702448093, 1.06641702448093, 1.49705629744449],
            [-1.26383691565959, 0.171820963796518, 1.46658366223522],
            [-1.25099240242015, 0.509631663390022, 1.39518518784344],
            [-1.26383691565959, -0.171820963796518, 1.46658366223522],
            [-1.25099240242015, -0.509631663390022, 1.39518518784344],
            [1.06641702448093, -1.06641702448093, 1.49705629744449],
            [-0.513335736607712, 0.270003604911569, 1.21666065848072],
            [-0.5, 0.25, 1.25],
            [-0.270003604911569, 0.513335736607712, 1.21666065848072],
            [-0.25, 0.5, 1.25],
            [-0.25, -0.25, 1.25],
            [-0.5, -0.5, 1.25],
            [2.22337658215132, -0.438434594743311, -0.661811176894628],
            [2.30753452029000, -0.200065448226512, -0.707338175610461],
            [-0.509631663390022, -1.25099240242015, 1.39518518784344],
            [-0.171820963796518, -1.26383691565959, 1.46658366223522],
            [-0.5, -0.5, -1.25],
            [-0.509631663390022, -1.25099240242015, -1.39518518784344],
            [-0.171820963796518, -1.26383691565959, -1.46658366223522],
            [1.06641702448093, 1.06641702448093, -1.49705629744449],
            [1.08929483235248, 1.92299398158712, -1.17902864378653],
            [2.22337658215132, 0.438434594743310, -0.661811176894628],
            [2.30753452029000, 0.200065448226511, -0.707338175610461],
            [-0.438434594743311, -2.22337658215132, -0.661811176894628],
            [-0.200065448226512, -2.30753452029000, -0.707338175610461],
            [0.171820963796518, -1.26383691565959, -1.46658366223522],
            [0.509631663390022, -1.25099240242015, -1.39518518784344],
            [1.06641702448093, -1.06641702448093, -1.49705629744449],
            [1.25099240242015, -0.509631663390022, -1.39518518784344],
            [1.26383691565959, -0.171820963796518, -1.46658366223522],
            [1.25099240242015, 0.509631663390022, -1.39518518784344],
            [1.26383691565959, 0.171820963796518, -1.46658366223522]
        ])
        XgID_expected = np.array(
            [9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,
             36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62,
             63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89,
             90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112,
             113, 114, 115, 116, 117, 118, 119, 120])

        # Test
        assert_array1D(XgID_expected, XgID_test)
        assert_matrix(X_expected, X_test)
